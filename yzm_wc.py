from PIL import Image

bmp0 = [[0, 0, 0, 1, 1, 1, 1, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 1, 1, 0, 1, 0, 0],
	[0, 0, 1, 0, 1, 1, 0, 1, 0, 0],
	[0, 0, 1, 0, 1, 1, 0, 1, 0, 0],
	[0, 0, 1, 0, 1, 1, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 1, 1, 1, 1, 0, 0, 0]]
bmp1 = [[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 1, 1, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 1, 1, 1, 1, 1, 0, 0, 0]]
bmp2 = [[0, 0, 0, 1, 1, 1, 1, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
	[0, 0, 0, 0, 0, 1, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 1, 0, 0, 0, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 1, 1, 1, 1, 1, 0, 0]]
bmp3 = [[0, 0, 0, 1, 1, 1, 1, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
	[0, 0, 0, 0, 1, 1, 0, 0, 0, 0],
	[0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 1, 1, 1, 1, 0, 0, 0]]
bmp4 = [[0, 0, 0, 0, 0, 1, 0, 0, 0, 0],
	[0, 0, 0, 0, 0, 1, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 1, 0, 0, 0, 0],
	[0, 0, 0, 1, 0, 1, 0, 0, 0, 0],
	[0, 0, 1, 0, 0, 1, 0, 0, 0, 0],
	[0, 0, 1, 0, 0, 1, 0, 0, 0, 0],
	[0, 0, 1, 1, 1, 1, 1, 1, 0, 0],
	[0, 0, 0, 0, 0, 1, 0, 0, 0, 0],
	[0, 0, 0, 0, 0, 1, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 1, 1, 1, 0, 0]]
bmp5 = [[0, 0, 1, 1, 1, 1, 1, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
	[0, 0, 1, 0, 1, 1, 1, 0, 0, 0],
	[0, 0, 1, 1, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 1, 1, 1, 1, 0, 0, 0]]
bmp6 = [[0, 0, 0, 0, 1, 1, 1, 0, 0, 0],
	[0, 0, 0, 1, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
	[0, 0, 1, 0, 1, 1, 1, 0, 0, 0],
	[0, 0, 1, 1, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 1, 1, 1, 1, 0, 0, 0]]
bmp7 = [[0, 0, 1, 1, 1, 1, 1, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
	[0, 0, 0, 0, 0, 1, 0, 0, 0, 0],
	[0, 0, 0, 0, 0, 1, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
	[0, 0, 0, 0, 1, 0, 0, 0, 0, 0]]
bmp8 = [[0, 0, 0, 1, 1, 1, 1, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 1, 1, 1, 1, 0, 0, 0],
	[0, 0, 0, 1, 1, 1, 1, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 1, 1, 1, 1, 0, 0, 0]]
bmp9 = [[0, 0, 0, 1, 1, 1, 0, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 1, 1, 0, 0],
	[0, 0, 0, 1, 1, 1, 0, 1, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 0, 0, 0, 0, 0, 1, 0, 0],
	[0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
	[0, 0, 0, 1, 1, 1, 0, 0, 0, 0]]
bmp = [bmp0, bmp1, bmp2, bmp3, bmp4, bmp5, bmp6, bmp7, bmp8, bmp9]

# pixel value is either white(255,255,255) or red(211,0,0)
def get_bin_table(image):
    rows, cols = image.size
    # 本来应该是10行，40列，这里读到的image是40行，10列，做一个转换
    table = [ [0] * rows for i in range(cols) ]
    for i in range(rows):
        for j in range(cols):
            pixel = image.getpixel((i,j))
            if pixel == (211,0,0):
                table[j][i] = 1
    return table

def get_a_number_from_table(table):
    my_dict = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0}
    for k in range(10):
        for i in range(10):
            for j in range(10):
                if bmp[k][i][j] != table[i][j]:
                    my_dict[k] += 1
    count_min = min(my_dict.values())
    my_dict_reverse = {v:k for k,v in my_dict.items()}
    number = my_dict_reverse[count_min]
    return number


def get_numbers_from_table(table):
    length = 10
    numbers = ''
    for k in range(4):
        single_digit_table = [ [0] * length for i in range(length) ]
        for i in range(length):
            for j in range(length):
                single_digit_table[i][j] = table[i][length*k + j]
        numbers += str(get_a_number_from_table(single_digit_table))
    return numbers


def get_yzm(image_path='./checkcode.png'):
    image = Image.open(image_path)
    table = get_bin_table(image)
    numbers = get_numbers_from_table(table)
    return numbers
